<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Secure Checkout | YouAndINotAI Pre-Order</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;700&family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }

        :root {
            --gold: #FFD700;
            --royal-red: #DC143C;
            --dark: #0a0a0a;
            --card-bg: #111;
            --border: #222;
            --text: #ccc;
            --success: #4CAF50;
        }

        body {
            font-family: 'Montserrat', sans-serif;
            background: linear-gradient(135deg, #0a0a0a 0%, #1a0a0a 100%);
            color: #fff;
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .checkout-wrap {
            max-width: 520px;
            width: 100%;
        }

        /* Back link */
        .back-link {
            display: inline-block;
            color: var(--gold);
            text-decoration: none;
            margin-bottom: 20px;
            font-size: 0.9rem;
        }
        .back-link:hover { text-decoration: underline; }

        /* Header */
        .checkout-header {
            text-align: center;
            margin-bottom: 24px;
        }
        .checkout-header h1 {
            font-family: 'Playfair Display', serif;
            font-size: 1.8rem;
            color: var(--gold);
            margin-bottom: 6px;
        }
        .checkout-header p {
            color: var(--text);
            font-size: 0.95rem;
        }

        /* Product summary */
        .product-card {
            background: var(--card-bg);
            border: 2px solid var(--gold);
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 20px;
        }
        .product-name {
            font-family: 'Playfair Display', serif;
            font-size: 1.3rem;
            color: var(--gold);
            margin-bottom: 4px;
        }
        .product-price {
            font-size: 2.2rem;
            font-weight: 700;
            margin-bottom: 16px;
        }
        .product-price .suffix {
            font-size: 0.9rem;
            color: var(--text);
            font-weight: 400;
        }
        .benefits {
            list-style: none;
        }
        .benefits li {
            padding: 6px 0;
            color: var(--text);
            font-size: 0.9rem;
        }
        .benefits li::before {
            content: '\2665';
            color: var(--royal-red);
            margin-right: 8px;
        }

        /* Card type selector (Royalty only) */
        .card-selector {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }
        .card-opt {
            padding: 14px 6px;
            border: 2px solid var(--border);
            border-radius: 12px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s;
            background: var(--card-bg);
        }
        .card-opt:hover { border-color: var(--gold); }
        .card-opt.selected {
            border-color: var(--gold);
            background: rgba(255, 215, 0, 0.1);
        }
        .card-opt.claimed {
            opacity: 0.3;
            cursor: not-allowed;
            pointer-events: none;
        }
        .card-opt .icon { font-size: 1.6rem; margin-bottom: 4px; }
        .card-opt .label { font-size: 0.75rem; color: var(--text); }

        /* Payment methods section */
        .payment-section {
            background: var(--card-bg);
            border: 2px solid var(--border);
            border-radius: 16px;
            padding: 24px;
            margin-bottom: 16px;
        }
        .payment-section h3 {
            font-size: 0.85rem;
            color: var(--text);
            text-transform: uppercase;
            letter-spacing: 1px;
            margin-bottom: 16px;
        }

        /* Digital wallets */
        .wallet-buttons {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-bottom: 0;
        }
        #google-pay-button {
            min-height: 48px;
            border-radius: 8px;
            overflow: hidden;
        }
        #apple-pay-button {
            min-height: 48px;
            border-radius: 8px;
            overflow: hidden;
        }
        .wallet-unavailable {
            display: none;
        }

        /* Divider */
        .or-divider {
            display: flex;
            align-items: center;
            gap: 16px;
            margin: 20px 0;
            color: #444;
            font-size: 0.8rem;
            text-transform: uppercase;
            letter-spacing: 2px;
        }
        .or-divider::before,
        .or-divider::after {
            content: '';
            flex: 1;
            height: 1px;
            background: #333;
        }

        /* Card form */
        .form-group {
            margin-bottom: 16px;
        }
        .form-group label {
            display: block;
            margin-bottom: 6px;
            color: var(--text);
            font-size: 0.85rem;
        }
        .form-group input {
            width: 100%;
            padding: 14px;
            border: 1px solid var(--border);
            border-radius: 10px;
            background: var(--dark);
            color: #fff;
            font-size: 1rem;
            font-family: inherit;
        }
        .form-group input:focus {
            outline: none;
            border-color: var(--gold);
        }

        #card-container {
            min-height: 90px;
            padding: 14px;
            border: 1px solid var(--border);
            border-radius: 10px;
            background: var(--dark);
        }

        .pay-btn {
            width: 100%;
            padding: 16px;
            background: linear-gradient(135deg, var(--gold), #FFA500);
            border: none;
            border-radius: 50px;
            color: var(--dark);
            font-size: 1.1rem;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.25s;
            margin-top: 8px;
            font-family: inherit;
        }
        .pay-btn:hover {
            transform: scale(1.02);
            box-shadow: 0 8px 24px rgba(255, 215, 0, 0.35);
        }
        .pay-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }

        /* Trust badges */
        .trust-row {
            display: flex;
            justify-content: center;
            gap: 20px;
            margin: 20px 0;
            flex-wrap: wrap;
        }
        .trust-badge {
            display: flex;
            align-items: center;
            gap: 6px;
            color: #666;
            font-size: 0.78rem;
        }
        .trust-badge .dot { color: var(--success); }

        /* Joker entry callout */
        .joker-callout {
            background: rgba(148, 0, 211, 0.15);
            border: 1px solid rgba(148, 0, 211, 0.4);
            border-radius: 12px;
            padding: 14px;
            text-align: center;
            font-size: 0.85rem;
            color: var(--text);
        }
        .joker-callout strong { color: var(--gold); }

        /* Error */
        .error-box {
            background: rgba(220, 20, 60, 0.15);
            border: 1px solid var(--royal-red);
            border-radius: 10px;
            padding: 14px;
            margin-bottom: 16px;
            display: none;
            color: #ff6b6b;
            font-size: 0.9rem;
        }

        /* Success */
        .success-screen {
            text-align: center;
            padding: 40px 20px;
            display: none;
        }
        .success-screen h2 {
            font-family: 'Playfair Display', serif;
            color: var(--gold);
            font-size: 1.8rem;
            margin-bottom: 12px;
        }
        .success-screen p {
            color: var(--text);
            margin-bottom: 16px;
        }
        .txn-id-box {
            background: rgba(255, 215, 0, 0.12);
            border: 2px solid var(--gold);
            border-radius: 10px;
            padding: 16px;
            font-family: monospace;
            font-size: 1.1rem;
            margin: 20px 0;
            word-break: break-all;
            color: var(--gold);
        }
        .success-screen .note {
            font-size: 0.85rem;
            color: #888;
        }

        /* Loading spinner */
        .spinner {
            display: inline-block;
            width: 18px;
            height: 18px;
            border: 2px solid #333;
            border-top-color: var(--gold);
            border-radius: 50%;
            animation: spin 0.6s linear infinite;
            vertical-align: middle;
            margin-right: 8px;
        }
        @keyframes spin { to { transform: rotate(360deg); } }

        /* Responsive */
        @media (max-width: 480px) {
            .checkout-header h1 { font-size: 1.4rem; }
            .product-price { font-size: 1.8rem; }
            .card-selector { grid-template-columns: repeat(2, 1fr); }
        }
    </style>
</head>
<body>
    <div class="checkout-wrap">
        <a href="./" class="back-link">&larr; Back to Pre-Order</a>

        <div class="checkout-header">
            <h1>Secure Checkout</h1>
            <p>Pre-Order — Launches Valentine's Day 2026</p>
        </div>

        <!-- CHECKOUT FLOW -->
        <div id="checkout-flow">
            <!-- Product summary (populated by JS) -->
            <div class="product-card" id="product-card"></div>

            <!-- Error display -->
            <div class="error-box" id="error-box"></div>

            <!-- Card type selector (Royalty purchases only) -->
            <div id="royalty-selector" style="display:none;">
                <div class="payment-section">
                    <h3>Choose Your Card</h3>
                    <div class="card-selector">
                        <div class="card-opt" data-card="ACE">
                            <div class="icon">A&spades;</div>
                            <div class="label">Ace</div>
                        </div>
                        <div class="card-opt" data-card="KING">
                            <div class="icon">K&spades;</div>
                            <div class="label">King</div>
                        </div>
                        <div class="card-opt" data-card="QUEEN">
                            <div class="icon">Q&hearts;</div>
                            <div class="label">Queen</div>
                        </div>
                        <div class="card-opt" data-card="JACK">
                            <div class="icon">J&diams;</div>
                            <div class="label">Jack</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- DIGITAL WALLETS (Google Pay / Apple Pay) -->
            <div class="payment-section" id="wallet-section">
                <h3>Express Checkout</h3>
                <div class="wallet-buttons">
                    <div id="google-pay-button"></div>
                    <div id="apple-pay-button"></div>
                </div>
                <div id="wallet-loading" style="text-align:center;padding:12px;color:#666;font-size:0.85rem;">
                    Loading payment methods...
                </div>
            </div>

            <div class="or-divider">or pay with card</div>

            <!-- CARD PAYMENT FORM -->
            <div class="payment-section">
                <h3>Card Payment</h3>
                <form id="card-form">
                    <div class="form-group">
                        <label for="cust-name">Full Name</label>
                        <input type="text" id="cust-name" required placeholder="Your name" autocomplete="name">
                    </div>
                    <div class="form-group">
                        <label for="cust-email">Email</label>
                        <input type="email" id="cust-email" required placeholder="your@email.com" autocomplete="email">
                    </div>
                    <div class="form-group">
                        <label>Card Details</label>
                        <div id="card-container"></div>
                    </div>
                    <button type="submit" class="pay-btn" id="pay-btn" disabled>
                        Complete Pre-Order
                    </button>
                </form>
            </div>

            <!-- Trust badges -->
            <div class="trust-row">
                <span class="trust-badge"><span class="dot">&#9679;</span> Secured by Square</span>
                <span class="trust-badge"><span class="dot">&#9679;</span> Google Pay</span>
                <span class="trust-badge"><span class="dot">&#9679;</span> Apple Pay</span>
                <span class="trust-badge"><span class="dot">&#9679;</span> 256-bit SSL</span>
            </div>

            <!-- Joker drawing entry -->
            <div class="joker-callout">
                Your transaction ID is automatically entered into the <strong>Joker Drawing</strong> on Valentine's Day!
            </div>
        </div>

        <!-- SUCCESS SCREEN -->
        <div class="success-screen" id="success-screen">
            <h2>Pre-Order Confirmed!</h2>
            <p>Welcome to the YouAndINotAI family.</p>
            <div class="txn-id-box" id="txn-id"></div>
            <p>Save this Transaction ID &mdash; it's your Joker Drawing entry!</p>
            <p class="note">You'll receive a confirmation email shortly.<br>Your membership activates on February 14, 2026.</p>
            <a href="./" class="back-link" style="margin-top:24px;">Back to Pre-Order Page</a>
        </div>
    </div>

    <!-- Square Web Payments SDK -->
    <script src="https://web.squarecdn.com/v1/square.js"></script>

    <script>
        // ─── CONFIG ────────────────────────────────────────────
        const SQUARE_APP_ID  = 'sq0idp-O4K4lNKXVSQoWdfgczv17Q';
        const SQUARE_LOC_ID  = 'LMX91E4QMFCXF';

        // ─── PRODUCTS ──────────────────────────────────────────
        const PRODUCTS = {
            'early-bird': {
                name: 'Early Bird Premium',
                price: '$4.99',
                suffix: '/mo for life',
                amount: '4.99',
                endpoint: '/api/payments/preorder/early-bird',
                benefits: [
                    '$5 OFF every month — locked for life',
                    'Premium features on launch day',
                    'Early access badge on profile',
                    'Entry into Joker Drawing'
                ]
            },
            'founding-member': {
                name: 'Founding Member Premium',
                price: '$14.99',
                suffix: '/mo',
                amount: '14.99',
                endpoint: '/api/payments/preorder/founding-member',
                benefits: [
                    'Price LOCKED for life (save 50%)',
                    'Premium features on Valentine\'s Day launch',
                    'Founding Member badge on profile',
                    'Entry into Joker Drawing'
                ]
            },
            'royalty': {
                name: 'Royalty Founder Card',
                price: '$1,000',
                suffix: 'one-time',
                amount: '1000.00',
                endpoint: '/api/payments/preorder/royalty',
                showCardSelector: true,
                benefits: [
                    'Choose: Ace, King, Queen, or Jack',
                    'Unique animated card border',
                    'Premium FREE FOR LIFE',
                    'UNLIMITED Super Likes forever',
                    'DAO voting rights',
                    'Entry into Joker Drawing'
                ]
            }
        };

        // ─── STATE ─────────────────────────────────────────────
        const params = new URLSearchParams(window.location.search);
        const checkoutType = params.get('type') || 'early-bird';
        const product = PRODUCTS[checkoutType] || PRODUCTS['early-bird'];
        let selectedCard = null;
        let squareCard = null;
        let squareGooglePay = null;
        let squareApplePay = null;

        // ─── RENDER PRODUCT ────────────────────────────────────
        function renderProduct() {
            document.getElementById('product-card').innerHTML = `
                <div class="product-name">${product.name}</div>
                <div class="product-price">${product.price} <span class="suffix">${product.suffix}</span></div>
                <ul class="benefits">${product.benefits.map(b => `<li>${b}</li>`).join('')}</ul>
            `;
            document.getElementById('pay-btn').textContent =
                `Pay ${product.price} ${checkoutType !== 'royalty' ? product.suffix : ''}`;

            // Show card selector for Royalty
            if (product.showCardSelector) {
                document.getElementById('royalty-selector').style.display = 'block';
            }
        }

        // ─── CARD SELECTOR (ROYALTY) ───────────────────────────
        document.querySelectorAll('.card-opt').forEach(el => {
            el.addEventListener('click', () => {
                if (el.classList.contains('claimed')) return;
                document.querySelectorAll('.card-opt').forEach(o => o.classList.remove('selected'));
                el.classList.add('selected');
                selectedCard = el.dataset.card;
            });
        });

        // ─── INITIALIZE SQUARE ─────────────────────────────────
        async function initSquare() {
            if (!window.Square) {
                showError('Payment system failed to load. Please refresh the page.');
                return;
            }

            const payments = window.Square.payments(SQUARE_APP_ID, SQUARE_LOC_ID);

            // Payment request for digital wallets
            const paymentRequest = payments.paymentRequest({
                countryCode: 'US',
                currencyCode: 'USD',
                total: {
                    amount: product.amount,
                    label: product.name,
                    pending: false
                }
            });

            // 1. GOOGLE PAY
            try {
                squareGooglePay = await payments.googlePay(paymentRequest);
                await squareGooglePay.attach('#google-pay-button');

                squareGooglePay.addEventListener('token', async (e) => {
                    await processPayment(e.detail.token);
                });
            } catch (e) {
                console.log('Google Pay not available:', e.message);
                document.getElementById('google-pay-button').classList.add('wallet-unavailable');
            }

            // 2. APPLE PAY
            try {
                squareApplePay = await payments.applePay(paymentRequest);
                await squareApplePay.attach('#apple-pay-button');

                squareApplePay.addEventListener('token', async (e) => {
                    await processPayment(e.detail.token);
                });
            } catch (e) {
                console.log('Apple Pay not available:', e.message);
                document.getElementById('apple-pay-button').classList.add('wallet-unavailable');
            }

            // Hide wallet section if neither is available
            const gpAvail = !document.getElementById('google-pay-button').classList.contains('wallet-unavailable');
            const apAvail = !document.getElementById('apple-pay-button').classList.contains('wallet-unavailable');
            document.getElementById('wallet-loading').style.display = 'none';

            if (!gpAvail && !apAvail) {
                document.getElementById('wallet-section').style.display = 'none';
                document.querySelector('.or-divider').style.display = 'none';
            }

            // 3. CARD
            squareCard = await payments.card();
            await squareCard.attach('#card-container');

            // Enable pay button once card is ready
            document.getElementById('pay-btn').disabled = false;
        }

        // ─── CARD FORM SUBMIT ──────────────────────────────────
        document.getElementById('card-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            if (!squareCard) return;

            // Royalty: require card type selection
            if (product.showCardSelector && !selectedCard) {
                showError('Please select your card type (Ace, King, Queen, or Jack).');
                return;
            }

            const btn = document.getElementById('pay-btn');
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner"></span> Processing...';
            hideError();

            try {
                const result = await squareCard.tokenize();
                if (result.status !== 'OK') {
                    throw new Error(result.errors?.[0]?.message || 'Card verification failed');
                }
                await processPayment(result.token);
            } catch (err) {
                showError(err.message);
                btn.disabled = false;
                btn.textContent = `Pay ${product.price} ${checkoutType !== 'royalty' ? product.suffix : ''}`;
            }
        });

        // ─── PROCESS PAYMENT ───────────────────────────────────
        async function processPayment(sourceToken) {
            const btn = document.getElementById('pay-btn');
            btn.disabled = true;
            btn.innerHTML = '<span class="spinner"></span> Processing...';
            hideError();

            try {
                const name = document.getElementById('cust-name').value;
                const email = document.getElementById('cust-email').value;

                // Validate name/email for card payments (wallets provide their own)
                if (!name && !email && !sourceToken) {
                    throw new Error('Please enter your name and email.');
                }

                const body = {
                    sourceId: sourceToken,
                    email: email || 'wallet-checkout@youandinotai.com',
                    name: name || 'Wallet Customer'
                };

                if (product.showCardSelector) {
                    body.cardType = selectedCard;
                }

                const response = await fetch(product.endpoint, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(body)
                });

                const data = await response.json();

                if (!response.ok || !data.success) {
                    throw new Error(data.error || data.message || 'Payment failed. Please try again.');
                }

                // SUCCESS
                showSuccess(data.transactionId || data.paymentId);

            } catch (err) {
                showError(err.message);
                btn.disabled = false;
                btn.textContent = `Pay ${product.price} ${checkoutType !== 'royalty' ? product.suffix : ''}`;
            }
        }

        // ─── UI HELPERS ────────────────────────────────────────
        function showError(msg) {
            const el = document.getElementById('error-box');
            el.textContent = msg;
            el.style.display = 'block';
            el.scrollIntoView({ behavior: 'smooth', block: 'center' });
        }

        function hideError() {
            document.getElementById('error-box').style.display = 'none';
        }

        function showSuccess(txnId) {
            document.getElementById('checkout-flow').style.display = 'none';
            document.getElementById('success-screen').style.display = 'block';
            document.getElementById('txn-id').textContent = txnId;
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        // ─── BOOT ──────────────────────────────────────────────
        document.addEventListener('DOMContentLoaded', () => {
            renderProduct();
            initSquare();
        });
    </script>
</body>
</html>
